#!/usr/bin/env python3
import argparse
import os
import re
import sys
import time

BASE_DIR = os.path.dirname(os.path.abspath(__file__))

# ANSI color codes
class Colors:
    RESET = "\033[0m"
    GREEN = "\033[92m"
    YELLOW = "\033[93m"
    RED = "\033[91m"
    CYAN = "\033[96m"
    BOLD = "\033[1m"
    DIM = "\033[2m"


# Expected file structure
REQUIRED_FILES = [
    "names.txt",
    "hie/pri/svgs.txt",
    "hie/sec/svgs.txt",
    "mon/pri/svgs.txt",
    "mon/sec/svgs.txt",
    "mul/pri/svgs.txt",
    "mul/sec/svgs.txt",
]

STRUCTURE_DIAGRAM = f"""
{Colors.BOLD}Expected directory structure:{Colors.RESET}

  {Colors.CYAN}<script-directory>/{Colors.RESET}
  ├── names.txt
  ├── hie/
  │   ├── pri/
  │   │   └── svgs.txt
  │   └── sec/
  │       └── svgs.txt
  ├── mon/
  │   ├── pri/
  │   │   └── svgs.txt
  │   └── sec/
  │       └── svgs.txt
  └── mul/
      ├── pri/
      │   └── svgs.txt
      └── sec/
          └── svgs.txt
"""


def print_progress(current, total, bar_length=40):
    """Print a progress bar that updates in place."""
    percent = current / total
    filled = int(bar_length * percent)
    bar = "█" * filled + "░" * (bar_length - filled)
    sys.stdout.write(f"\r  {Colors.DIM}[{bar}] {current}/{total} ({percent*100:.1f}%){Colors.RESET}")
    sys.stdout.flush()


def format_duration(seconds):
    """Format duration in human readable format."""
    if seconds < 1:
        return f"{seconds*1000:.0f}ms"
    elif seconds < 60:
        return f"{seconds:.1f}s"
    else:
        mins = int(seconds // 60)
        secs = seconds % 60
        return f"{mins}m {secs:.1f}s"


def check_structure():
    """Check if the required file structure exists. Returns list of missing files."""
    missing = []
    for file_path in REQUIRED_FILES:
        full_path = os.path.join(BASE_DIR, file_path)
        if not os.path.exists(full_path):
            missing.append(file_path)
    return missing


def print_structure_error(missing_files):
    """Print error message with expected structure diagram."""
    print(f"{Colors.RED}ERROR:{Colors.RESET} Required files are missing:\n")
    for f in missing_files:
        print(f"  {Colors.RED}✗{Colors.RESET} {f}")
    print(STRUCTURE_DIAGRAM)


def count_extracted_svgs():
    """Count extracted SVG files in one variant/color directory. Returns 0 if none exist."""
    # Check one directory (hie/pri) as reference - all should have the same count
    check_dir = os.path.join(BASE_DIR, "hie", "pri")
    if not os.path.exists(check_dir):
        return 0
    svg_files = [f for f in os.listdir(check_dir) if f.endswith(".svg")]
    return len(svg_files)


def update_readme_badge():
    """Update the SF Symbols badge in README.md with the current SVG count."""
    svg_count = count_extracted_svgs()

    if svg_count == 0:
        print(f"{Colors.YELLOW}⊘{Colors.RESET} No extracted SVGs found. Run {Colors.BOLD}./sfe{Colors.RESET} first to extract SVGs.")
        return False

    readme_path = os.path.join(BASE_DIR, "README.md")
    if not os.path.exists(readme_path):
        print(f"{Colors.RED}ERROR:{Colors.RESET} README.md not found")
        return False

    with open(readme_path, "r") as f:
        content = f.read()

    # Pattern to match the SF Symbols badge
    pattern = r'(!\[SF Symbols\]\(https://img\.shields\.io/badge/SF%20Symbols-)\d+(-blue\?style=flat&logo=apple&logoColor=white\))'
    new_badge = rf'\g<1>{svg_count}\2'

    new_content, count = re.subn(pattern, new_badge, content)

    if count == 0:
        print(f"{Colors.YELLOW}⊘{Colors.RESET} SF Symbols badge not found in README.md")
        return False

    with open(readme_path, "w") as f:
        f.write(new_content)

    # Calculate statistics
    variants = 3  # hie, mon, mul
    colors = 2    # pri, sec
    per_variant = svg_count * colors
    total_svgs = svg_count * variants * colors

    # Format numbers right-aligned
    width = len(f"{total_svgs:,}")

    print(f"{Colors.GREEN}✓{Colors.RESET} Updated SF Symbols badge to {Colors.BOLD}{svg_count}{Colors.RESET}")
    print(f"  {Colors.DIM}├─{Colors.RESET} {Colors.CYAN}{total_svgs:>{width},}{Colors.RESET} SVGs total")
    print(f"  {Colors.DIM}├─{Colors.RESET} {Colors.CYAN}{per_variant:>{width},}{Colors.RESET} SVGs per variant")
    print(f"  {Colors.DIM}└─{Colors.RESET} {Colors.CYAN}{svg_count:>{width},}{Colors.RESET} SVGs per variant and color")
    return True


def main():
    parser = argparse.ArgumentParser(
        description="Extract individual SVG files from concatenated svgs.txt files.",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog=STRUCTURE_DIAGRAM
    )
    parser.add_argument(
        "-c", "--check",
        action="store_true",
        help="Only check the directory structure, don't extract files"
    )
    parser.add_argument(
        "-u", "--update-badge",
        action="store_true",
        help="Update the SF Symbols badge in README.md with the current SVG count"
    )
    args = parser.parse_args()

    # Check structure
    missing = check_structure()

    if args.check:
        if missing:
            print_structure_error(missing)
            sys.exit(1)
        else:
            print(f"{Colors.GREEN}✓{Colors.RESET} Directory structure is valid")
            sys.exit(0)

    if args.update_badge:
        success = update_readme_badge()
        sys.exit(0 if success else 1)

    if missing:
        print_structure_error(missing)
        sys.exit(1)

    # Statistics
    stats = {
        "processed": 0,
        "skipped": 0,
        "warnings": 0,
        "total_svgs": 0,
    }

    start_time = time.time()

    # Read names
    names_file = os.path.join(BASE_DIR, "names.txt")
    with open(names_file, "r") as f:
        names = [line.strip() for line in f if line.strip()]

    print(f"{Colors.GREEN}✓{Colors.RESET} Loaded {Colors.BOLD}{len(names)}{Colors.RESET} names")

    # All svgs.txt paths (without names.txt)
    svg_files = [f for f in REQUIRED_FILES if f != "names.txt"]

    for svg_file in svg_files:
        full_path = os.path.join(BASE_DIR, svg_file)
        output_dir = os.path.dirname(full_path)

        print(f"\n{Colors.CYAN}Processing{Colors.RESET} {Colors.BOLD}{svg_file}{Colors.RESET}")

        if not os.path.exists(full_path):
            print(f"  {Colors.YELLOW}⊘ Skipping (file not found){Colors.RESET}")
            stats["skipped"] += 1
            continue

        os.makedirs(output_dir, exist_ok=True)

        with open(full_path, "r") as f:
            content = f.read()

        # Split by <?xml - each SVG starts with this
        parts = content.split('<?xml version="1.0" encoding="UTF-8"?>')
        # First part is empty, skip it
        svgs = [p.strip() for p in parts if p.strip()]

        if len(svgs) != len(names):
            print(f"  {Colors.RED}✗ WARNING:{Colors.RESET} SVG count ({len(svgs)}) != name count ({len(names)})")
            stats["warnings"] += 1
            continue

        for i, (name, svg_content) in enumerate(zip(names, svgs)):
            # Reconstruct full SVG with XML declaration
            full_svg = '<?xml version="1.0" encoding="UTF-8"?>\n' + svg_content

            output_path = os.path.join(output_dir, f"{name}.svg")
            with open(output_path, "w") as f:
                f.write(full_svg)

            print_progress(i + 1, len(names))

        stats["processed"] += 1
        stats["total_svgs"] += len(names)
        print(f"\n  {Colors.GREEN}✓ Done:{Colors.RESET} {len(names)} SVGs saved")

    # Calculate duration
    duration = time.time() - start_time

    # Print statistics
    print(f"\n{Colors.BOLD}{'─' * 50}{Colors.RESET}")
    print(f"{Colors.GREEN}{Colors.BOLD}All done!{Colors.RESET}")
    print(f"{Colors.BOLD}{'─' * 50}{Colors.RESET}")
    print(f"  {Colors.CYAN}Duration:{Colors.RESET}    {format_duration(duration)}")
    print(f"  {Colors.CYAN}Categories:{Colors.RESET}  {stats['processed']} processed, {stats['skipped']} skipped, {stats['warnings']} warnings")
    print(f"  {Colors.CYAN}SVGs:{Colors.RESET}        {stats['total_svgs']:,} files written")
    if stats["total_svgs"] > 0 and duration > 0:
        rate = stats["total_svgs"] / duration
        print(f"  {Colors.CYAN}Speed:{Colors.RESET}       {rate:,.0f} files/sec")
    print(f"{Colors.BOLD}{'─' * 50}{Colors.RESET}")


if __name__ == "__main__":
    main()
